<!DOCTYPE html> <!--declares that it is ahtmly 5 doc. and the english language -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streak Map</title>
    <style> <!--ah so this literally ends the if statement -->
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
        }
        .map-container {
            width: 80%; /* Allow full width of parent container - thi is a 'responseive' width */
            height: 300px;
            margin: 20px auto;
            border: 2px solid black;
            position: relative;
        }
        form {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

    <h2>Select a Streak ID</h2>
    <form method="POST">
        <input type="number" name="streak_id" placeholder="Enter Streak ID" required>
        <button type="submit">Generate Map</button>
    </form>

    {% if error_message %}
        <p style="color: red;">{{ error_message }}</p>
    {% endif %}

    <button id="toggle-filter">Toggle Filtered Map</button>

    <div class="map-container">
        {{ map_html|safe }}
    </div>

    <h3>Data Table</h3>
    <div class="table-container">
        <table id="data-table" border="1">
            <thead>
                <tr>
                    <th>Unique ID</th>
                    <th>Date</th>
                    <th>Home</th>
                    <th>Away</th>
                    <th>Latitude</th>
                    <th>Longitude</th>
                </tr>
            </thead>
            <tbody>
                {% for row in gdf_data %}
                <tr data-lat="{{ row.geometry.y }}" data-lon="{{ row.geometry.x }}">
                    <td>{{ row.unique_id }}</td>
                    <td>{{ row.date }}</td>
                    <td>{{ row.home }}</td>
                    <td>{{ row.away }}</td>
                    <td>{{ row.geometry.y }}</td>
                    <td>{{ row.geometry.x }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        let map; // Global map variable

        document.getElementById("toggle-filter").addEventListener("click", function() {
            fetch("/toggle_map")
                .then(response => response.text())
                .then(data => {
                    document.querySelector(".map-container").innerHTML = data;
                    updateMap();
                });
        });

        function updateMap() {
            map = document.querySelector(".map-container iframe");
        }

        // Zoom to location when row is clicked
        document.querySelectorAll("#data-table tbody tr").forEach(row => {
            row.addEventListener("click", function() {
                let lat = parseFloat(this.dataset.lat);
                let lon = parseFloat(this.dataset.lon);

                if (map && map.contentWindow) {
                    map.contentWindow.postMessage({ zoomTo: [lat, lon] }, "*");
                }
            });
        });

        updateMap();
    </script>

    <style>
	
	.map-container {
    width: 80%;
    height: 500px;
    margin-bottom: 50px; /* Adds space between map and table */
	}

	.table-container {
		width: 90%;
		margin: auto;
		max-height: 300px;
		overflow-y: auto; /* Enables scrolling if too many rows */
	}

        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 8px;
            border: 1px solid black;
            text-align: center;
        }
        tr:hover {
            background-color: lightgray;
            cursor: pointer;
        }
    </style>

</body>
<script>
    function updateMap() {
        let mapFrame = document.querySelector(".map-container iframe");

        document.querySelectorAll("#data-table tbody tr").forEach(row => {
            row.addEventListener("click", function() {
                let lat = parseFloat(this.dataset.lat);
                let lon = parseFloat(this.dataset.lon);

                if (mapFrame && mapFrame.contentWindow) {
                    mapFrame.contentWindow.postMessage({ zoomTo: [lat, lon] }, "*");
                }
            });
        });
    }

    window.addEventListener("message", function(event) {
        if (event.data.zoomTo) {
            let [lat, lon] = event.data.zoomTo;
            zoomToLocation(lat, lon);
        }
    });

    updateMap();
</script>
</html>