<!DOCTYPE html> <!--declares that it is ahtmly 5 doc. and the english language -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streak Map</title>
    <style> <!--ah so this literally ends the if statement -->
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
        }
        .map-container {
            width: 80%; /* Allow full width of parent container - thi is a 'responseive' width */
            height: 300px;
            margin: 20px auto;
            border: 2px solid black;
            position: relative;
        }
        form {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

    <h2>How Many Days Gaps Between Games are you after? (choose between 1-10)</h2>
    <form method="POST">
        <input type="number" name="streak_gap" placeholder="Enter Day Gap" required min="1" max="10"> <!--Required 1 - 10 means they ahve put 1-10 -->
        <button type="submit">Generate Itineraries</button>
    </form>

    {% if error_message %}
        <p style="color: red;">{{ error_message }}</p>
    {% endif %}
	
	<!--<form method="POST">
        <input type="number" name="streak_id" placeholder="Enter Streak ID" required min="1" max="10"> <!--Required 1 - 10 means they ahve put 1-10 -->
     <!--   <button type="submit">Generate Map</button>
    </form>

    <button id="toggle-filter">Toggle Filtered Map</button>-->



    <h3>Data Table</h3>
    <div class="table-container">
        <table id="data-table" border="1">
            <thead>
                <tr >
  
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Country</th>
					<th>Number of Matches in a row</th>
					<th>ID</th>

                </tr>
            </thead>
            <tbody>
                {% for row in df_data %} <!-- So this you have to match the table. also make sure the columns below match .columns!-->
                <tr data-streak-id="{{ row.Streak_ID }}"> <!-- tr means table row -->
                    
                    <td>{{ row.interval_start_date }}</td>
                    <td>{{ row.interval_end_date }}</td>
                    <td>{{ row.streak_country }}</td>
					<td>{{ row.day_interval }}</td>
					<td>{{ row.Streak_ID }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
	
	<div class="map-container">
        {{ map_html|safe }}
    </div>
	
	<button id="filter-btn">Filter</button>

	<h3>Filtered Data Table</h3>
	<div class="table-container">
		<table id="filtered-data-table" border="1">
			<thead>
				<tr>
					<th>Date</th>
					<th>Home</th>
					<th>Away</th>
					<th>Stadium Location</th>
				</tr>
			</thead>
			<tbody>
				<!-- Filtered data will be inserted here dynamically -->
			</tbody>
		</table>
	</div>

	
<script>
document.addEventListener("DOMContentLoaded", function() {
    function attachRowClickEvents() {
        document.querySelectorAll("#data-table tbody tr").forEach(row => {
            row.removeEventListener("click", rowClickHandler); // Remove old event listener (prevents duplicates)
            row.addEventListener("click", rowClickHandler); // Attach new one
        });
    }

    function rowClickHandler(event) {
        let streakId = event.currentTarget.dataset.streakId; // Ensure we get the correct row's streak ID

        if (streakId) {
            document.querySelector(".map-container").innerHTML = "<p>Loading map...</p>";

            fetch(`/get_streak/${streakId}`)
                .then(response => response.text())
                .then(data => {
                    document.querySelector(".map-container").innerHTML = data;
                })
                .catch(error => {
                    console.error("Error fetching streak:", error);
                    document.querySelector(".map-container").innerHTML = "<p style='color: red;'>Failed to load map.</p>";
                });
        }
    }

    // **Fix for the filter button**
    let filterButton = document.getElementById("filter-btn");
    if (filterButton) {
        filterButton.addEventListener("click", function() {
            fetch("/toggle_map_and_table")
                .then(response => response.text())
                .then(html => {
                    let parser = new DOMParser();
                    let doc = parser.parseFromString(html, "text/html");

                    // Update the map
                    document.querySelector(".map-container").innerHTML = doc.querySelector(".map-container").innerHTML;

                    // Update the table
                    // Update the main streak table
					let mainTable = document.querySelector("#data-table tbody");
					mainTable.innerHTML = ""; // Clear existing rows

					let newRows = doc.querySelectorAll("#data-table tbody tr");  
					newRows.forEach(row => {
						let clonedRow = row.cloneNode(true);
						mainTable.appendChild(clonedRow);
					});

					// Update the filtered data table
					let filteredTable = document.querySelector("#filtered-data-table tbody");
					filteredTable.innerHTML = ""; // Clear existing rows

					let filteredData = doc.querySelectorAll("#filtered-data-table tbody tr");
					filteredData.forEach(row => {
						let clonedRow = row.cloneNode(true);
						filteredTable.appendChild(clonedRow);
					});


                    // **Reattach Click Events** to restore streak selection
                    attachRowClickEvents();

                    // Toggle button text
                    filterButton.textContent = (filterButton.textContent === "Filter") ? "Show Original" : "Filter";
                })
                .catch(error => console.error("Error toggling filter:", error));
        });
    }

    // **Ensure row clicks work when the page loads**
    attachRowClickEvents();
});
</script>
</html>