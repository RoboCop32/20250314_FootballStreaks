<!DOCTYPE html> <!--declares that it is ahtmly 5 doc. and the english language -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streak Map</title>
    <style> <!--ah so this literally ends the if statement -->
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
        }
        .map-container {
            width: 80%; /* Allow full width of parent container - thi is a 'responseive' width */
            height: 300px;
            margin: 20px auto;
            border: 2px solid black;
            position: relative;
        }
        form {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

    <h2>How Many Days Gaps Between Games are you after? (choose between 1-10)</h2>
    <form method="POST">
        <input type="number" name="streak_gap" placeholder="Enter Day Gap" required min="1" max="10"> <!--Required 1 - 10 means they ahve put 1-10 -->
        <button type="submit">Generate Itineraries</button>
    </form>

    {% if error_message %}
        <p style="color: red;">{{ error_message }}</p>
    {% endif %}
	
	<!--<form method="POST">
        <input type="number" name="streak_id" placeholder="Enter Streak ID" required min="1" max="10"> <!--Required 1 - 10 means they ahve put 1-10 -->
     <!--   <button type="submit">Generate Map</button>
    </form>

    <button id="toggle-filter">Toggle Filtered Map</button>-->



    <h3>Data Table</h3>
    <div class="table-container">
        <table id="data-table" border="1">
            <thead>
                <tr >
  
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Country</th>
					<th>Number of Matches in a row</th>
					<th>ID</th>

                </tr>
            </thead>
            <tbody>
                {% for row in df_data %} <!-- So this you have to match the table. also make sure the columns below match .columns!-->
                <tr data-streak-id="{{ row.Streak_ID }}"> <!-- tr means table row -->
                    
                    <td>{{ row.interval_start_date }}</td>
                    <td>{{ row.interval_end_date }}</td>
                    <td>{{ row.streak_country }}</td>
					<td>{{ row.day_interval }}</td>
					<td>{{ row.Streak_ID }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
	
	<div class="map-container">
        {{ map_html|safe }}
    </div>
	
<script>
document.addEventListener("DOMContentLoaded", function() {
    function attachRowClickEvents() { //function with no paramters
        document.querySelectorAll("#data-table tbody tr").forEach(row => { //.query selector - this selects all tabe rows inside of element datatable. AND .forEach is a loop, and executes the following code...
            row.addEventListener("click", function() { //this listens to a Click
                let streakId = this.dataset.streakId; //'this' refers to the row that was clicked. it refers to where you were  doing <tr data streak id = 222 >
                
                if (streakId) { //simple if statement
                    document.querySelector(".map-container").innerHTML = "<p>Loading map...</p>";

                    fetch(`/get_streak/${streakId}`) //fetch is used to send a request to the server
                        .then(response => response.text()) //this just converts the reposne to plain text
                        .then(data => { //.then is used as part of a Promise.
                            document.querySelector(".map-container").innerHTML = data;
                            updateMap();  // Ensure map updates properly
                        })
                        .catch(error => { //arrow is a shorthand way to write functions
                            console.error("Error fetching streak:", error);
                            document.querySelector(".map-container").innerHTML = "<p style='color: red;'>Failed to load map.</p>";
                        });
                }
            });
        });
    }

    function updateMap() {
        let mapFrame = document.querySelector(".map-container iframe");

        document.querySelectorAll("#data-table tbody tr").forEach(row => {
            row.addEventListener("click", function() {
                let lat = parseFloat(this.dataset.lat);
                let lon = parseFloat(this.dataset.lon);

                if (mapFrame && mapFrame.contentWindow) {
                    mapFrame.contentWindow.postMessage({ zoomTo: [lat, lon] }, "*");
                }
            });
        });
    }

    // Rebind row click events whenever the form is submitted
    document.querySelector("form").addEventListener("submit", function() {
        setTimeout(() => {
            document.querySelector(".map-container").innerHTML = "";  // Clear the map
            attachRowClickEvents();  // Reattach click events to new table rows
        }, 500);  // Delay to allow data update
    });

    // Handle toggle filtered map button
    let toggleButton = document.getElementById("toggle-filter");
    if (toggleButton) {
        toggleButton.addEventListener("click", function() {
            fetch("/toggle_map")
                .then(response => response.text())
                .then(data => {
                    document.querySelector(".map-container").innerHTML = data;
                    updateMap();
                });
        });
    }

    attachRowClickEvents();  // Initial binding on page load
});
</script>
</html>